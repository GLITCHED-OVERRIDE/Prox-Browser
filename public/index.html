<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="Icon.png" />
<link rel="manifest" href="manifest.json"/>
<title>Glitch Hub Proxy</title>

<!-- Ultraviolet -->
<script src="/uv/bundle.js"></script>
<script src="/uv/config.js"></script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/uv/sw.js", { scope: __uv$config.prefix });
}
</script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#111827;
  --panel2:#0f172a;
  --accent:#00eaff;
  --accent-soft:rgba(0,234,255,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --danger:#7f1d1d;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Segoe UI,system-ui;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* ---------------- TABS ---------------- */
#tabsBar{
  display:flex;
  align-items:flex-end;
  gap:6px;
  padding:6px 8px;
  background:linear-gradient(to right,#0f172a,#111827);
}

.tab{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 30px 8px 12px;
  background:#1f2937;
  border-radius:10px 10px 0 0;
  cursor:pointer;
  position:relative;
  max-width:220px;
  overflow:hidden;
  transition:.2s;
}

.tab:hover{background:#263042}

.tab.active{
  background:var(--panel2);
  box-shadow:0 0 12px var(--accent-soft);
}

.tab.active::after{
  content:"";
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:2px;
  background:var(--accent);
}

.tab img{width:16px;height:16px}
.tab span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tab .close{position:absolute;right:8px;color:var(--muted)}
.tab .close:hover{color:#ff4d4d}

#newTabBtn{
  padding:8px 12px;
  background:#0f172a;
  border-radius:8px;
  cursor:pointer;
  transition:.2s;
}
#newTabBtn:hover{background:#1e293b}

/* ---------------- BROWSER BAR ---------------- */
#browserBar{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px;
  background:var(--panel);
  border-bottom:1px solid #1f2937;
}

.ctrl{
  padding:6px 10px;
  background:#0f172a;
  border:none;
  color:var(--text);
  border-radius:8px;
  cursor:pointer;
  transition:.2s;
}
.ctrl:hover{
  background:var(--accent-soft);
  color:var(--accent);
}

#urlWrap{position:relative;flex:1}

#urlBar{
  width:100%;
  padding:10px 40px 10px 14px;
  background:#0f172a;
  border:1px solid #1f2937;
  border-radius:12px;
  color:var(--text);
  font-family:monospace;
}
#urlBar:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 8px var(--accent-soft);
}

#bookmarkStar{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}
#bookmarkStar:hover{color:var(--accent)}

#menuPanel{
  position:absolute;
  top:52px;
  right:12px;
  background:#0f172a;
  border:1px solid #1f2937;
  border-radius:12px;
  display:none;
  flex-direction:column;
  min-width:180px;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
  z-index:1000;
}

#menuPanel button{
  padding:10px 14px;
  background:none;
  border:none;
  color:var(--text);
  text-align:left;
  cursor:pointer;
}
#menuPanel button:hover{
  background:var(--accent-soft);
  color:var(--accent);
}

/* ---------------- BOOKMARK BAR ---------------- */
#bookmarkBar{
  display:flex;
  gap:8px;
  padding:8px;
  background:#0f172a;
  border-bottom:1px solid #1f2937;
  overflow-x:auto;
}

.bookmarkButton{
  padding:6px 12px;
  background:#111827;
  border-radius:8px;
  cursor:pointer;
  font-size:.85rem;
}
.bookmarkButton:hover{
  background:var(--accent-soft);
  color:var(--accent);
}

/* ---------------- CONTENT ---------------- */
#frames{flex:1;position:relative;background:black}

iframe,.customPage{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:none;
  display:none;
}

iframe.active,.customPage.active{display:block}

.customPage{
  background:#0f172a;
  padding:30px;
  overflow:auto;
}

.customHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.customHeader button{
  padding:8px 14px;
  background:#1f2937;
  border:none;
  border-radius:8px;
  color:var(--text);
  cursor:pointer;
}
.customHeader button:hover{
  background:var(--accent-soft);
  color:var(--accent);
}

.listItem{
  padding:14px;
  border-radius:10px;
  background:#111827;
  margin-bottom:10px;
}
.listItem span{color:var(--muted);font-size:.8rem}

.deleteBtn{
  background:var(--danger) !important;
}

/* ---------------- MODALS ---------------- */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  justify-content:center;
  align-items:center;
  backdrop-filter:blur(4px);
  z-index:2000;
}

.modalBox{
  background:#0f172a;
  padding:26px;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
  min-width:320px;
}

.modalBox input{
  padding:10px;
  background:#111827;
  border:1px solid #1f2937;
  border-radius:10px;
  color:var(--text);
}

.modalBox button{
  padding:8px;
  border:none;
  border-radius:10px;
  background:#1f2937;
  color:var(--text);
  cursor:pointer;
}
.modalBox button:hover{
  background:var(--accent-soft);
  color:var(--accent);
}
</style>
</head>

<body>

<div id="tabsBar">
  <div id="newTabBtn" onclick="newTab()">＋</div>
</div>

<div id="browserBar">
  <button class="ctrl" onclick="goBack()">⟵</button>
  <button class="ctrl" onclick="goForward()">⟶</button>
  <button class="ctrl" onclick="reloadTab()">⟳</button>
  <div id="urlWrap">
    <input id="urlBar" placeholder="Enter URL">
    <span id="bookmarkStar" onclick="toggleBookmark()">☆</span>
  </div>
  <button class="ctrl" onclick="fullscreen()">⛶</button>
  <button class="ctrl" id="menuBtn">⋮</button>

  <div id="menuPanel">
    <button onclick="newTab()">New Tab</button>
    <button onclick="openCustom('/?/History')">History</button>
    <button onclick="openCustom('/?/Bookmarks')">Bookmarks</button>
    <button onclick="injectDev()">Dev Tools</button>
    <button onclick="openCustom('/?/Settings')">Settings</button>
  </div>
</div>

<div id="bookmarkBar"></div>
<div id="frames"></div>

<!-- Bookmark Modals -->
<div id="bmCreate" class="modal">
  <div class="modalBox">
    <input id="bmCreateName" placeholder="Name">
    <input id="bmCreateCode" placeholder="URL or JS">
    <button onclick="saveBookmark()">Save</button>
    <button onclick="closeBM()">Cancel</button>
  </div>
</div>

<div id="bmEdit" class="modal">
  <div class="modalBox">
    <input id="bmEditName">
    <input id="bmEditCode">
    <button onclick="saveEdit()">Save</button>
    <button class="deleteBtn" onclick="deleteBM()">Delete</button>
    <button onclick="closeBM()">Cancel</button>
  </div>
</div>

<script>
// All original proxy logic preserved exactly

const frames=document.getElementById("frames");
const urlBar=document.getElementById("urlBar");
const star=document.getElementById("bookmarkStar");
const menu=document.getElementById("menuPanel");
const bookmarkBar=document.getElementById("bookmarkBar");
const menuBtn=document.getElementById("menuBtn");

let tabs=[],active=null;
let bookmarks=JSON.parse(localStorage.getItem("bookmarks")||"{}");
let historyLog=JSON.parse(localStorage.getItem("history")||"[]");
let lastURL=null,userTyping=false,editKey=null;

let defaultBrowser=localStorage.getItem("defaultBrowser")||"Startpage";
const browserSearchURLs={
  "Startpage":"https://www.startpage.com/sp/search?q=",
  "Google":"https://www.google.com/search?q=",
  "DuckDuckGo":"https://duckduckgo.com/?q=",
  "Brave":"https://search.brave.com/search?q=",
  "Bing":"https://www.bing.com/search?q="
};

menuBtn.onclick=()=>menu.style.display="flex";
menu.onmouseleave=()=>menu.style.display="none";

function normalize(v){
  if(v.startsWith("/?/")) return v;
  if(!v.includes(".")) return browserSearchURLs[defaultBrowser]+encodeURIComponent(v);
  if(!v.startsWith("http")) return "https://"+v;
  return v;
}

function newTab(url){
  if(!url) url=browserSearchURLs[defaultBrowser];
  const iframe=document.createElement("iframe");
  frames.appendChild(iframe);

  const tab=document.createElement("div");
  tab.className="tab";
  tab.innerHTML=`<img><span>New Tab</span><span class="close">✕</span>`;
  document.getElementById("tabsBar").insertBefore(tab,newTabBtn);

  const t={iframe,tab,url,mode:"proxy",custom:null};
  tabs.push(t);

  tab.onclick=()=>activate(t);
  tab.querySelector(".close").onclick=e=>{e.stopPropagation();closeTab(t)};

  iframe.onload=()=>{
    try{
      const doc=iframe.contentDocument;
      tab.querySelector("span").textContent=doc.title||url;
      const ico=doc.querySelector("link[rel~='icon']");
      if(ico) tab.querySelector("img").src=ico.href;
    }catch{}
  };

  iframe.src=__uv$config.prefix+__uv$config.encodeUrl(url);
  activate(t);
}

function activate(t){
  tabs.forEach(x=>{
    x.tab.classList.remove("active");
    x.iframe.classList.remove("active");
    if(x.custom)x.custom.classList.remove("active");
  });
  active=t;
  t.tab.classList.add("active");
  (t.mode==="proxy"?t.iframe:t.custom).classList.add("active");
}

urlBar.onfocus=()=>userTyping=true;
urlBar.onblur=()=>userTyping=false;
urlBar.onkeydown=e=>{
  if(e.key!=="Enter")return;
  const v=normalize(urlBar.value);
  if(v.startsWith("/?/"))openCustom(v);
  else{
    active.mode="proxy";
    active.iframe.src=__uv$config.prefix+__uv$config.encodeUrl(v);
  }
};

function updateURL(){
  if(!active||userTyping)return;
  if(active.mode==="proxy"){
    try{
      const raw=active.iframe.contentWindow.location.href;
      if(!raw.includes(__uv$config.prefix))return;
      const enc=raw.split(__uv$config.prefix)[1];
      const decoded=__uv$config.decodeUrl(enc.replace(/^\/+/,""));
      active.url=decoded;
      urlBar.value=decoded;
      star.textContent=bookmarks[decoded]?"★":"☆";
      trackHistory(decoded);
    }catch{}
  }else urlBar.value=active.url;
}
setInterval(updateURL,400);

function trackHistory(url){
  if(!url||url===lastURL||url.startsWith("/?/"))return;
  lastURL=url;
  historyLog.push({url,time:new Date().toLocaleString()});
  localStorage.setItem("history",JSON.stringify(historyLog));
}

function goBack(){active?.iframe.contentWindow.history.back()}
function goForward(){active?.iframe.contentWindow.history.forward()}
function reloadTab(){active?.iframe.contentWindow.location.reload()}
function fullscreen(){active?.iframe.requestFullscreen()}

function closeTab(t){
  t.tab.remove();
  t.iframe.remove();
  if(t.custom)t.custom.remove();
  tabs=tabs.filter(x=>x!==t);
  tabs.length?activate(tabs.at(-1)):newTab();
}

function toggleBookmark(){
  if(bookmarks[active.url])openEdit(active.url);
  else{
    bmCreateName.value=active.url;
    bmCreateCode.value=active.url;
    bmCreate.style.display="flex";
  }
}

function saveBookmark(){
  bookmarks[bmCreateCode.value]={name:bmCreateName.value,code:bmCreateCode.value};
  localStorage.setItem("bookmarks",JSON.stringify(bookmarks));
  closeBM();
  renderBookmarks();
}

function openEdit(key){
  editKey=key;
  bmEditName.value=bookmarks[key].name;
  bmEditCode.value=bookmarks[key].code;
  bmEdit.style.display="flex";
}

function saveEdit(){
  delete bookmarks[editKey];
  bookmarks[bmEditCode.value]={name:bmEditName.value,code:bmEditCode.value};
  localStorage.setItem("bookmarks",JSON.stringify(bookmarks));
  closeBM();
  renderBookmarks();
}

function deleteBM(){
  delete bookmarks[editKey];
  localStorage.setItem("bookmarks",JSON.stringify(bookmarks));
  closeBM();
  renderBookmarks();
}

function closeBM(){
  bmCreate.style.display="none";
  bmEdit.style.display="none";
}

function renderBookmarks(){
  bookmarkBar.innerHTML="";
  Object.keys(bookmarks).forEach(url=>{
    const b=document.createElement("div");
    b.className="bookmarkButton";
    b.textContent=bookmarks[url].name;
    b.onclick=()=>newTab(url);
    bookmarkBar.appendChild(b);
  });
}
renderBookmarks();

function openCustom(path){
  if(active.custom)active.custom.remove();
  const page=document.createElement("div");
  page.className="customPage active";
  frames.appendChild(page);
  active.custom=page;
  active.mode="custom";
  active.url=path;

  if(path==="/?/History"){
    page.innerHTML=`<div class="customHeader">
      <h1>History</h1>
      <button onclick="closeCustom()">Close</button>
    </div>`;
    historyLog.forEach(h=>{
      page.innerHTML+=`<div class="listItem">${h.url}<br><span>${h.time}</span></div>`;
    });
  }

  if(path==="/?/Bookmarks"){
    page.innerHTML=`<div class="customHeader">
      <h1>Bookmarks</h1>
      <button onclick="closeCustom()">Close</button>
    </div>`;
    Object.values(bookmarks).forEach(b=>{
      page.innerHTML+=`<div class="listItem">${b.name}<br><span>${b.code}</span></div>`;
    });
  }
}

function closeCustom(){
  if(active.custom)active.custom.remove();
  active.custom=null;
  active.mode="proxy";
}

function injectDev(){
  try{
    const d=active.iframe.contentDocument;
    const s=d.createElement("script");
    s.src="//cdn.jsdelivr.net/npm/eruda";
    s.onload=()=>{
      const i=d.createElement("script");
      i.textContent="eruda.init();";
      d.body.appendChild(i);
    };
    d.body.appendChild(s);
  }catch{}
}

window.onload=()=>{newTab(browserSearchURLs[defaultBrowser])}
</script>
</body>
</html>
