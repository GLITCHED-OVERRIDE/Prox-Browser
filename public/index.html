<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="Icon.png" />
<link rel="manifest" href="manifest.json"/>
<title>Glitch Hub Proxy</title>

<!-- UV Proxy -->
<script src="/uv/uv.bundle.js"></script>
<script src="/uv/uv.config.js"></script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/uv/sw.js", { scope: __uv$config.prefix });
}
</script>
<style>
/* SIDEBAR OVERLAY */
#menuPanel{
  position:fixed;
  top:0;
  right:-320px; /* initially hidden */
  height:100vh;
  width:280px;
  background:rgba(18,20,28,.97);
  backdrop-filter:blur(16px);
  box-shadow:-4px 0 20px rgba(0,0,0,.7);
  border-radius:12px 0 0 12px;
  display:flex;
  flex-direction:column;
  padding:24px;
  gap:16px;
  z-index:10000;
  transition:right .25s ease;
}

#menuPanel.show{
  right:0;
}

/* Sidebar header */
#menuPanelHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

#menuPanelHeader h2{
  font-size:1.2rem;
  font-weight:600;
  color:var(--text);
}

#menuCloseBtn{
  font-size:20px;
  cursor:pointer;
  color:var(--muted);
  transition:.2s;
}
#menuCloseBtn:hover{
  color:var(--accent);
}

/* Sidebar buttons */
#menuPanel button{
  padding:10px 14px;
  background:rgba(255,255,255,.06);
  color:var(--text);
  border:none;
  border-radius:10px;
  cursor:pointer;
  text-align:left;
  font-size:.95rem;
  transition:.2s;
}
#menuPanel button:hover{
  background:var(--accent);
  color:white;
}

/* overlay behind sidebar for click-to-close */
#menuOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(2px);
  display:none;
  z-index:9999;
}
#menuOverlay.show{
  display:block;
}
</style>
</head>

<body>

<!-- TABS -->
<div id="tabsBar">
  <div id="newTabBtn" onclick="newTab()">＋</div>
</div>

<!-- BROWSER BAR -->
<div id="browserBar">
  <button class="ctrl" onclick="goBack()">⟵</button>
  <button class="ctrl" onclick="goForward()">⟶</button>
  <button class="ctrl" onclick="reloadTab()">⟳</button>
  <div id="urlWrap">
    <input id="urlBar" placeholder="Enter URL">
    <span id="bookmarkStar" onclick="toggleBookmark()">☆</span>
  </div>
  <button class="ctrl" onclick="fullscreen()">⛶</button>
  <button class="ctrl" id="menuBtn">⋮</button>

  <div id="menuPanel">
    <button onclick="newTab()">New Tab</button>
    <button onclick="openCustom('/?/History')">History</button>
    <button onclick="openCustom('/?/Bookmarks')">Bookmarks</button>
    <button onclick="injectDev()">Dev Tools</button>
    <button onclick="openCustom('/?/Settings')">Settings</button>
  </div>
</div>

<div id="bookmarkBar"></div>
<div id="frames"></div>

<!-- BOOKMARK MODALS -->
<div id="bmCreate" class="modal">
  <div class="modalBox">
    <input id="bmCreateName" placeholder="Name">
    <input id="bmCreateCode" placeholder="URL or JS">
    <button onclick="saveBookmark()">Save</button>
    <button onclick="closeBM()">Cancel</button>
  </div>
</div>

<div id="bmEdit" class="modal">
  <div class="modalBox">
    <input id="bmEditName">
    <input id="bmEditCode">
    <button onclick="saveEdit()">Save</button>
    <button class="deleteBtn" onclick="deleteBM()">Delete</button>
    <button onclick="closeBM()">Cancel</button>
  </div>
</div>

<script>
  // =================== HISTORY FIX ===================
function refreshHistoryPage(){
  if (typeof active !== "undefined" && active.custom) {
    active.custom.remove();
    active.custom = null;
  }
  openCustom("/?/History");
}

function deleteHistoryItem(index){
  historyLog.splice(index, 1);
  localStorage.setItem("history", JSON.stringify(historyLog));
  refreshHistoryPage();
}

function clearHistory(){
  if (!confirm("Clear all history?")) return;
  historyLog.length = 0;
  localStorage.setItem("history", "[]");
  refreshHistoryPage();
}
// ==================================================
// ------------------- PROXY BROWSER LOGIC -------------------
const frames = document.getElementById("frames");
const urlBar = document.getElementById("urlBar");
const star = document.getElementById("bookmarkStar");
const menu = document.getElementById("menuPanel");
const bookmarkBar = document.getElementById("bookmarkBar");
const menuBtn = document.getElementById("menuBtn");

let tabs = [], active = null;
let bookmarks = JSON.parse(localStorage.getItem("bookmarks")||"{}");
let historyLog = JSON.parse(localStorage.getItem("history")||"[]");
let lastURL = null, userTyping = false, editKey = null;

// Default browser search
let defaultBrowser = localStorage.getItem("defaultBrowser") || "Startpage";
const browserSearchURLs = {
  "Startpage": "https://www.startpage.com/sp/search?q=",
  "Google": "https://www.google.com/search?q=",
  "DuckDuckGo": "https://duckduckgo.com/?q=",
  "Brave": "https://search.brave.com/search?q=",
  "Bing": "https://www.bing.com/search?q="
};

// MENU
menuBtn.onclick = () => menu.style.display = "flex";
menu.onmouseleave = () => menu.style.display = "none";

// Normalize URL
function normalize(v){
  if(v.startsWith("/?/")) return v;
  if(!v.includes(".")) return browserSearchURLs[defaultBrowser]+encodeURIComponent(v);
  if(!v.startsWith("http")) return "https://"+v;
  return v;
}

// ------------------- TABS -------------------
function newTab(url){
  if(!url) url = browserSearchURLs[defaultBrowser];
  const iframe = document.createElement("iframe");
  frames.appendChild(iframe);

  const tab = document.createElement("div");
  tab.className = "tab";
  tab.innerHTML = `<img><span>New Tab</span><span class="close">✕</span>`;
  document.getElementById("tabsBar").insertBefore(tab, document.getElementById("newTabBtn"));

  const t = {iframe, tab, url, mode:"proxy", custom:null};
  tabs.push(t);

  // Tab click
  tab.onclick = () => activate(t);
  tab.querySelector(".close").onclick = e => { e.stopPropagation(); closeTab(t); };

  // Set favicon and title after iframe loads
  iframe.onload = () => {
    try{
      const doc = iframe.contentDocument;
      tab.querySelector("span").textContent = doc.title || url;
      const ico = doc.querySelector("link[rel~='icon']");
      if(ico) tab.querySelector("img").src = ico.href;
    } catch{}
  };

  iframe.src = __uv$config.prefix + __uv$config.encodeUrl(url);
  activate(t);
}

// ACTIVATE TAB
function activate(t){
  tabs.forEach(x => {
    x.tab.classList.remove("active");
    x.iframe.classList.remove("active");
    if(x.custom) x.custom.classList.remove("active");
  });
  active = t;
  t.tab.classList.add("active");
  (t.mode==="proxy"?t.iframe:t.custom).classList.add("active");
}

// URL Bar
urlBar.onfocus = () => userTyping = true;
urlBar.onblur = () => userTyping = false;
urlBar.onkeydown = e => {
  if(e.key!=="Enter") return;
  const v = normalize(urlBar.value);
  if(v.startsWith("/?/")) openCustom(v);
  else {
    active.mode="proxy";
    active.iframe.src = __uv$config.prefix + __uv$config.encodeUrl(v);
  }
};

// Update URL & history
function updateURL(){
  if(!active||userTyping) return;
  if(active.mode==="proxy"){
    try{
      const raw = active.iframe.contentWindow.location.href;
      if(!raw.includes(__uv$config.prefix)) return;
      const enc = raw.split(__uv$config.prefix)[1];
      const decoded = __uv$config.decodeUrl(enc.replace(/^\/+/,""));
      active.url = decoded;
      urlBar.value = decoded;
      star.textContent = bookmarks[decoded]?"★":"☆";
      trackHistory(decoded);
    } catch{}
  } else urlBar.value = active.url;
}
setInterval(updateURL,400);

function trackHistory(url){
  if(!url||url===lastURL||url.startsWith("/?/")) return;
  lastURL=url;
  historyLog.push({url,time:new Date().toLocaleString()});
  localStorage.setItem("history",JSON.stringify(historyLog));
}

// ------------------- CONTROLS -------------------
function goBack(){active?.iframe.contentWindow.history.back()}
function goForward(){active?.iframe.contentWindow.history.forward()}
function reloadTab(){active?.iframe.contentWindow.location.reload()}
function fullscreen(){active?.iframe.requestFullscreen()}
function closeTab(t){
  t.tab.remove(); t.iframe.remove(); if(t.custom) t.custom.remove();
  tabs = tabs.filter(x=>x!==t);
  tabs.length ? activate(tabs.at(-1)) : newTab();
}

// ------------------- BOOKMARKS -------------------
function toggleBookmark(){if(bookmarks[active.url]) openEdit(active.url); else {bmCreateName.value=active.url;bmCreateCode.value=active.url;bmCreate.style.display="flex"}}
function saveBookmark(){bookmarks[bmCreateCode.value]={name:bmCreateName.value,code:bmCreateCode.value};localStorage.setItem("bookmarks",JSON.stringify(bookmarks));closeBM();renderBookmarks()}
function openEdit(key){editKey=key;bmEditName.value=bookmarks[key].name;bmEditCode.value=bookmarks[key].code;bmEdit.style.display="flex"}
function saveEdit(){delete bookmarks[editKey];bookmarks[bmEditCode.value]={name:bmEditName.value,code:bmEditCode.value};localStorage.setItem("bookmarks",JSON.stringify(bookmarks));closeBM();renderBookmarks()}
function deleteBM(){delete bookmarks[editKey];localStorage.setItem("bookmarks",JSON.stringify(bookmarks));closeBM();renderBookmarks()}
function closeBM(){bmCreate.style.display="none";bmEdit.style.display="none"}
function renderBookmarks(){
  bookmarkBar.innerHTML="";
  Object.keys(bookmarks).forEach(url=>{
    const b=document.createElement("div");
    b.className="bookmarkButton";
    b.textContent=bookmarks[url].name;
    let t;
    b.onmousedown=()=>t=setTimeout(()=>openEdit(url),600);
    b.onmouseup=b.onmouseleave=()=>clearTimeout(t);
    b.onclick=()=>url.startsWith("javascript:") ? (()=>{try{const s=active.iframe.contentDocument.createElement("script");s.textContent=url.replace("javascript:","");active.iframe.contentDocument.body.appendChild(s)}catch{}})() : newTab(url);
    bookmarkBar.appendChild(b);
  });
}
renderBookmarks();

// ------------------- CUSTOM PAGES -------------------
function openCustom(path){
  if(active.custom) active.custom.remove();
  const page=document.createElement("div");
  page.className="customPage active";
  frames.appendChild(page);
  active.custom=page;
  active.mode="custom";
  active.url=path;

if(path==="/?/History"){
  page.innerHTML=`
    <div class="customHeader">
      <h1>History</h1>
      <div>
        <button class="deleteBtn" onclick="clearHistory()">Clear All</button>
        <button onclick="closeCustom()">Close</button>
      </div>
    </div>
  `;

  historyLog.forEach((h,i)=>{
    page.innerHTML+=`
      <div class="listItem" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          ${h.url}<br>
          <span>${h.time}</span>
        </div>
        <button class="deleteBtn" onclick="deleteHistoryItem(${i})">✕</button>
      </div>
    `;
  });
}

  if(path==="/?/Bookmarks"){
    page.innerHTML=`<div class="customHeader"><h1>Bookmarks</h1><button onclick="closeCustom()">Close</button></div>`;
    Object.values(bookmarks).forEach(b=>page.innerHTML+=`<div class="listItem">${b.name}<br><span>${b.code}</span></div>`);
  }
  if(path==="/?/Settings"){
    page.innerHTML=`<div class="customHeader"><h1>Settings</h1><button onclick="closeCustom()">Close</button></div>
    <div class="customBody">
      <label for="browserSelect">Default Browser for Search:</label>
      <select id="browserSelect">
        <option>Startpage</option>
        <option>Google</option>
        <option>DuckDuckGo</option>
        <option>Brave</option>
        <option>Bing</option>
      </select>
    </div>`;
    const sel=document.getElementById("browserSelect");
    sel.value=defaultBrowser;
    sel.onchange=()=>{defaultBrowser=sel.value;localStorage.setItem("defaultBrowser",defaultBrowser);alert("Default browser set to: "+defaultBrowser);}
  }
}
function closeCustom(){if(active.custom) active.custom.remove();active.custom=null;active.mode="proxy"}

// ------------------- DEV TOOLS -------------------
function injectDev(){
  try{
    const d=active.iframe.contentDocument;
    const s=d.createElement("script");
    s.src="//cdn.jsdelivr.net/npm/eruda";
    s.onload=()=>{const i=d.createElement("script");i.textContent="eruda.init();";d.body.appendChild(i)};
    d.body.appendChild(s);
  }catch{}
}

// ------------------- AUTO OPEN TAB -------------------
window.onload = ()=>{ newTab(browserSearchURLs[defaultBrowser]); }

</script>
<script>
window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = "";
});
</script>
</body>
</html>
